<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta name="description" content="Bot.TalkDrove get unlimited free WhatsApp bots on your number here!">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
      
      <link rel="apple-touch-icon" sizes="180x180" href="https://cdn.talkdrove.com/host/Images/favicon/apple-touch-icon.png">
      <link rel="icon" type="image/png" sizes="32x32" href="https://cdn.talkdrove.com/host/Images/favicon/favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="https://cdn.talkdrove.com/host/Images/favicon/favicon-16x16.png">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>My Bot Requests || H.TD</title>
        <link rel="stylesheet" href="./styles/main.css">
    <style>
       
    

       
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--neutral);
        }

        .bots-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .bot-card {
            background-color: var(--base-100);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(229, 231, 235, 0.2);
            transition: all 0.2s ease;
        }

        .bot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--base-100);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            margin: 2rem auto;
            position: relative;
        }

        .close {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--neutral);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--neutral);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(229, 231, 235, 0.2);
            background-color: var(--base-200);
            color: var(--neutral);
        }

        .env-vars {
            margin-top: 1rem;
        }

        .env-var-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .remove-btn {
            background-color: var(--error);
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            padding: 0 0.5rem;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            z-index: 1000;
            color: white;
        }

        .success-message {
            background-color: var(--success);
        }

        .error-message {
            background-color: var(--error);
        }

        .status-badge {
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 0.75rem;
                    font-weight: 500;
                }
                .status-badge-approved {
                    background-color: var(--success);
                    color: white;
                }
                .status-badge-rejected {
                    background-color: var(--error);
                    color: white;
                }
                .status-badge-pending {
                    background-color: #FCD34D;
                    color: #92400E;
                }
                .status-badge-suspended {
                    background-color: #F87171;
                    color: white;
                }
                /* Add this CSS to your stylesheet */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    width: 80%;
    max-width: 500px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.close-modal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close-modal:hover,
.close-modal:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-control {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}

.form-text {
    display: block;
    margin-top: 5px;
    font-size: 0.8rem;
    color: #666;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}
    </style>
</head>
<body>
    <div class="error"></div>
    <div class="success"></div>

    <header class="header">
        <div class="header-content">
            <h1><a class="logo" href="/dashboard">H.TD</a></h1>    
                    <nav class="nav-controls">
                
                <button id="deployBotBtn" class="btn btn-primary" onclick="window.location.href='/dashboard/select-bot'">
                    <i class="fas fa-plus"></i>
                    <span>Deploy Bot</span>
                </button>
                <button id="themeToggle" class="btn btn-secondary">
                    <i class="fas fa-adjust"></i>
                </button>

                
                <div class="profile-container">
                    <img src="https://cdn.talkdrove.com/host/Images/profile.webp" alt="Profile" class="profile-pic" id="profileBtn">
                    <div class="dropdown" id="profileDropdown">
                        <a href="/dashboard/invite" class="dropdown-item">
                            <i class="fas fa-share"></i>
                            <span>Invite</span>
                        </a>
                        <a href="/dashboard/wallet" class="dropdown-item">
                            <i class="fas fa-wallet"></i>
                            <span>Wallet</span>
                        </a>
                        <a href="/dashboard/my-heroku" class="dropdown-item">
                            <i class="fas fa-server"></i>
                            <span>My Heroku</span>
                            <a href="/dashboard/account-settings" class="dropdown-item">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="/logout" class="dropdown-item" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </a>
                    </a></div>
                </div>
            </nav>
        </div>
    </header>

    <main class="main">
        <div id="botsList" class="bots-list">
            
        </div>
    </main>

   <div id="editRepoModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>Edit Repository</h3>
        <form id="editRepoForm">
            <input type="hidden" id="editBotId">
            <div class="form-group">
                <label for="editRepoUrl">Repository URL:</label>
                <input type="text" id="editRepoUrl" name="repoUrl" class="form-control" placeholder="username/repository" required>
                <small class="form-text">Format: username/repository</small>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>
    <script>
      let currentBots = [];

// Initialize modal elements
let modal = null;
let closeModalButtons = null;

function setupModal() {
    // Get the modal
    modal = document.getElementById("editRepoModal");
    
    // Get all elements that close the modal
    closeModalButtons = document.getElementsByClassName("close-modal");
    
    // Add click event to all close buttons
    Array.from(closeModalButtons).forEach(button => {
        button.onclick = function() {
            modal.style.display = "none";
        }
    });
    
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    }
    
    // Setup form submission
    const editRepoForm = document.getElementById("editRepoForm");
    editRepoForm.addEventListener("submit", function(e) {
        e.preventDefault();
        submitRepoChange();
    });
}

function openEditRepoModal(botId) {
    // Find the bot in currentBots array
    const bot = currentBots.find(b => b.id === botId);
    if (!bot) return;
    
    // Fill the form with current values
    document.getElementById("editBotId").value = botId;
    document.getElementById("editRepoUrl").value = bot.repo_url;
    
    // Display the modal
    modal.style.display = "block";
}

function submitRepoChange() {
    const botId = document.getElementById("editBotId").value;
    const newRepoUrl = document.getElementById("editRepoUrl").value.trim();
    
    // Validate input
    if (!newRepoUrl) {
        showMessage("Repository URL cannot be empty", "error");
        return;
    }
    
    // Find the bot to get its current data
    const bot = currentBots.find(b => b.id === parseInt(botId));
    if (!bot) return;
    
    // Prepare data for update
    const updateData = {
        name: bot.name,
        repoUrl: newRepoUrl,
        websiteUrl: bot.website_url || "",
        envVars: bot.env_vars || []
    };
    
    // Send update request
    fetch(`/bot/${botId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload bots
            modal.style.display = "none";
            loadBots();
            showMessage("Repository updated successfully!", "success");
        } else {
            showMessage(data.error || "Failed to update repository", "error");
        }
    })
    .catch(error => {
        console.error('Error updating repository:', error);
        showMessage("Error updating repository. Please try again.", "error");
    });
}

function loadBots() {
    fetch('/my-bots')
        .then(response => response.json())
        .then(bots => {
            currentBots = bots;
            const botsList = document.getElementById('botsList');
            botsList.innerHTML = bots.map(bot => `
                <div class="bot-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <h3 style="margin: 0; font-weight: bold;">${bot.name}</h3>
                                <span class="status-badge ${getStatusBadgeClass(bot.status)}">
                                    ${capitalize(bot.status)}
                                </span>
                            </div>
                            
                            <p style="margin: 4px 0; font-size: 0.875rem; color: var(--neutral);">
                                <strong>Repository:</strong> ${bot.repo_url}
                            </p>
                            <p style="margin: 4px 0; font-size: 0.875rem; color: var(--neutral);">
                                <strong>Website:</strong> ${bot.website_url || 'N/A'}
                            </p>

                            ${bot.pending_changes ? `
                                <div style="margin-top: 12px; padding: 12px; background-color: var(--secondary); border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: var(--primary);">Pending Changes:</h4>
                                    <p style="margin: 4px 0; font-size: 0.875rem;">
                                        <strong>Name:</strong> ${bot.pending_changes.name}
                                    </p>
                                    <p style="margin: 4px 0; font-size: 0.875rem;">
                                        <strong>Repository:</strong> ${bot.pending_changes.repo_url}
                                    </p>
                                    <p style="margin: 4px 0; font-size: 0.875rem;">
                                        <strong>Website:</strong> ${bot.pending_changes.website_url || 'N/A'}
                                    </p>
                                </div>
                            ` : ''}

                            <div style="margin-top: 12px;">
                                <h4 style="margin: 0 0 8px 0;">Environment Variables:</h4>
                                ${bot.env_vars.map(env => `
                                    <p style="margin: 4px 0; font-size: 0.875rem;">
                                        <strong>${env.name}:</strong> ${env.description}
                                    </p>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                          ${bot.status === 'approved' && !bot.pending_changes ? `
                            <button onclick="openEditRepoModal(${bot.id})" class="btn btn-secondary" title="Edit Repository">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="updateBotFromRepo(${bot.id})" class="btn btn-secondary" title="Update from Repository">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button 
                                onclick="redirectToBotDeployment(${bot.id})" 
                                class="btn btn-secondary" 
                                title="Prepare Deployment"
                            > 
                                <i class="fas fa-link"></i>
                            </button>
                            <button onclick="deleteBot(${bot.id})" class="btn btn-primary" title="Delete Bot">
                                <i class="fas fa-trash"></i>
                            </button>
                          ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            // Setup modal after DOM is updated
            setupModal();
        })
        .catch(error => {
            console.error('Error loading bots:', error);
            showMessage('Error loading bots. Please try again.', 'error');
        });
}

// Add this function to handle the update from repository action
function updateBotFromRepo(botId) {
    if (confirm('Are you sure you want to update this bot from the repository?')) {
        fetch(`/bot/${botId}/update-from-repo`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(() => {
            loadBots();
            showMessage('Bot updated successfully from repository!', 'success');
        })
        .catch(error => {
            console.error('Error updating bot from repository:', error);
            showMessage('Error updating bot. Please try again.', 'error');
        });
    }
}

function redirectToBotDeployment(botId) {
    const url = `/dashboard/select-bot/prepare-deployment?botId=${botId}`;
    window.location.href = url; // Redirect to the desired URL
}

// Helper functions
function getStatusBadgeClass(status) {
    return `status-badge-${status.toLowerCase()}`;
}

function capitalize(string) {
    return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
}

function getStatusClass(status) {
    switch (status.toLowerCase()) {
        case 'approved':
            return 'bg-green-100 text-green-800';
        case 'rejected':
            return 'bg-red-100 text-red-800';
        case 'pending':
            return 'bg-yellow-100 text-yellow-800';
        default:
            return 'bg-gray-100 text-gray-800';
    }
}

// Delete bot
function deleteBot(botId) {
    if (confirm('Are you sure you want to delete this bot?')) {
        fetch(`/bots/${botId}`, { 
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(() => {
            loadBots();
            showMessage('Bot deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting bot:', error);
            showMessage('Error deleting bot. Please try again.', 'error');
        });
    }
}

// Show message function
function showMessage(message, type = 'success') {
    const existingMessage = document.querySelector('.message');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// Initialize when the page loads
document.addEventListener('DOMContentLoaded', function() {
    loadBots();
    setupModal();
});
    </script>
<script src="./js/main.js"></script>
</body>
</html>
